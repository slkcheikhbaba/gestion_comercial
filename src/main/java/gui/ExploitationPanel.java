package gui;

import dao.ExploitationDAO;
import dao.AgenceDAO;
import dao.VilleDAO;
import model.Exploitation;
import model.Agence;
import model.Ville;
import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class ExploitationPanel extends JPanel {

    private JTable table;
    private DefaultTableModel model;
    private JTextField txtNom, txtType, txtSuperficie, txtAdresse, txtSearch;
    private JComboBox<String> comboVille, comboAgence;
    private JButton btnAjouter, btnModifier, btnEnregistrer, btnSupprimer, btnRechercher, btnActualiser, btnStats;
    private ExploitationDAO exploitationDAO = new ExploitationDAO();
    private VilleDAO villeDAO = new VilleDAO();
    private AgenceDAO agenceDAO = new AgenceDAO();
    private boolean isEditMode = false;
    private Long currentEditId = null;
    
    // Caches pour √©viter de chercher √† chaque fois
    private Map<Long, String> cacheVilles = new HashMap<>();
    private Map<Long, String> cacheAgences = new HashMap<>();

    public ExploitationPanel() {
        setLayout(new BorderLayout(10, 10));
        setBackground(new Color(240, 255, 240));
        setBorder(BorderFactory.createEmptyBorder(15, 15, 15, 15));

        // TITRE
        JLabel titre = new JLabel("GESTION DES EXPLOITATIONS", SwingConstants.CENTER);
        titre.setFont(new Font("Arial", Font.BOLD, 24));
        titre.setForeground(new Color(0, 100, 0));
        titre.setBorder(BorderFactory.createEmptyBorder(0, 0, 15, 0));
        add(titre, BorderLayout.NORTH);

        // PANEL STATISTIQUES (Nord)
        JPanel statsPanel = createStatsPanel();
        add(statsPanel, BorderLayout.NORTH);

        // PANEL CENTRE (Tableau)
        JPanel centerPanel = new JPanel(new BorderLayout());
        
        // Mod√®le de tableau
        String[] colonnes = {"ID", "NOM", "TYPE", "SUPERFICIE (ha)", "ADRESSE", "VILLE", "AGENCE"};
        model = new DefaultTableModel(colonnes, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        
        // Table
        table = createStyledTable();
        
        JScrollPane scrollPane = new JScrollPane(table);
        scrollPane.setBorder(BorderFactory.createTitledBorder(
            BorderFactory.createLineBorder(new Color(60, 179, 113), 2),
            "Liste des Exploitations"
        ));
        
        centerPanel.add(scrollPane, BorderLayout.CENTER);
        add(centerPanel, BorderLayout.CENTER);

        // PANEL FORMULAIRE (Sud)
        JPanel formPanel = createFormPanel();        
        JPanel formContainer = new JPanel(new BorderLayout());
        formContainer.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));
        formContainer.add(formPanel, BorderLayout.CENTER);
        add(formContainer, BorderLayout.SOUTH);

        // PANEL BOUTONS (Est)
        JPanel buttonPanel = createButtonPanel();
        add(buttonPanel, BorderLayout.EAST);
        
        // √âCOUTEURS D'√âV√âNEMENTS
        setupEventListeners();
        
        // CHARGEMENT INITIAL
        chargerCache(); // Charger les caches d'abord
        chargerDonnees();
        mettreAJourBoutons();
    }
    
    // M√âTHODES AUXILIAIRES
    private JPanel createStatsPanel() {
        JPanel statsPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 20, 5));
        statsPanel.setBackground(new Color(220, 240, 220));
        statsPanel.setBorder(BorderFactory.createTitledBorder("Statistiques"));
        
        JLabel lblTotal = new JLabel("Total: 0 exploitations");
        lblTotal.setFont(new Font("Arial", Font.BOLD, 12));
        lblTotal.setForeground(new Color(0, 100, 0));
        
        JLabel lblSuperficie = new JLabel("Superficie totale: 0 ha");
        lblSuperficie.setFont(new Font("Arial", Font.BOLD, 12));
        lblSuperficie.setForeground(new Color(0, 100, 0));
        
        btnStats = createButton("üìä STATISTIQUES", new Color(75, 0, 130));
        
        statsPanel.add(lblTotal);
        statsPanel.add(lblSuperficie);
        statsPanel.add(btnStats);
        
        // Mettre √† jour les statistiques
        updateStats();
        
        return statsPanel;
    }
    
    private JTable createStyledTable() {
        JTable table = new JTable(model);
        table.setRowHeight(30);
        table.setFont(new Font("Arial", Font.PLAIN, 12));
        table.getTableHeader().setFont(new Font("Arial", Font.BOLD, 13));
        table.getTableHeader().setBackground(new Color(60, 179, 113));
        table.getTableHeader().setForeground(Color.WHITE);
        table.setSelectionBackground(new Color(144, 238, 144));
        table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        
        table.setDefaultRenderer(Object.class, new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value,
                    boolean isSelected, boolean hasFocus, int row, int column) {
                Component c = super.getTableCellRendererComponent(table, value, 
                    isSelected, hasFocus, row, column);
                
                if (isSelected) {
                    c.setBackground(new Color(144, 238, 144));
                } else {
                    c.setBackground(row % 2 == 0 ? new Color(240, 255, 240) : Color.WHITE);
                }
                return c;
            }
        });
        
        return table;
    }
    
    private JPanel createFormPanel() {
        JPanel formPanel = new JPanel(new GridLayout(4, 4, 15, 15));
        formPanel.setBackground(Color.WHITE);
        formPanel.setBorder(BorderFactory.createTitledBorder(
            BorderFactory.createLineBorder(new Color(70, 130, 180), 2),
            "Informations de l'Exploitation"
        ));
        
        // Initialiser les combobox
        comboVille = new JComboBox<>();
        comboAgence = new JComboBox<>();
        chargerComboBox();
        
        // Champs de formulaire
        txtNom = createTextField();
        txtType = createTextField();
        txtSuperficie = createTextField();
        txtAdresse = createTextField();
        
        formPanel.add(createLabel("Nom *:"));
        formPanel.add(txtNom);
        formPanel.add(createLabel("Type:"));
        formPanel.add(txtType);
        formPanel.add(createLabel("Superficie (ha):"));
        formPanel.add(txtSuperficie);
        formPanel.add(createLabel("Adresse:"));
        formPanel.add(txtAdresse);
        formPanel.add(createLabel("Ville *:"));
        formPanel.add(comboVille);
        formPanel.add(createLabel("Agence *:"));
        formPanel.add(comboAgence);
        
        return formPanel;
    }
    
    private JPanel createButtonPanel() {
        JPanel buttonPanel = new JPanel();
        buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.Y_AXIS));
        buttonPanel.setBorder(BorderFactory.createEmptyBorder(0, 10, 0, 0));
        
        btnAjouter = createButton("‚ûï AJOUTER", new Color(34, 139, 34));
        btnModifier = createButton("‚úèÔ∏è MODIFIER", new Color(30, 144, 255));
        btnEnregistrer = createButton("üíæ ENREGISTRER", new Color(255, 140, 0));
        btnSupprimer = createButton("üóëÔ∏è SUPPRIMER", new Color(220, 20, 60));
        btnActualiser = createButton("üîÑ ACTUALISER", new Color(138, 43, 226));
        
        // Panel recherche
        JPanel searchPanel = new JPanel(new BorderLayout(5, 5));
        searchPanel.setBorder(BorderFactory.createTitledBorder("Recherche"));
        searchPanel.setBackground(Color.WHITE);
        
        txtSearch = new JTextField();
        txtSearch.setFont(new Font("Arial", Font.PLAIN, 12));
        btnRechercher = createButton("üîç RECHERCHER", new Color(32, 178, 170));
        
        searchPanel.add(txtSearch, BorderLayout.CENTER);
        searchPanel.add(btnRechercher, BorderLayout.EAST);
        
        // Ajout des boutons au panel
        buttonPanel.add(btnAjouter);
        buttonPanel.add(Box.createRigidArea(new Dimension(0, 10)));
        buttonPanel.add(btnModifier);
        buttonPanel.add(Box.createRigidArea(new Dimension(0, 10)));
        buttonPanel.add(btnEnregistrer);
        buttonPanel.add(Box.createRigidArea(new Dimension(0, 10)));
        buttonPanel.add(btnSupprimer);
        buttonPanel.add(Box.createRigidArea(new Dimension(0, 10)));
        buttonPanel.add(btnActualiser);
        buttonPanel.add(Box.createRigidArea(new Dimension(0, 20)));
        buttonPanel.add(searchPanel);
        
        return buttonPanel;
    }
    
    private JLabel createLabel(String text) {
        JLabel label = new JLabel(text);
        label.setFont(new Font("Arial", Font.BOLD, 12));
        return label;
    }
    
    private JTextField createTextField() {
        JTextField textField = new JTextField();
        textField.setFont(new Font("Arial", Font.PLAIN, 12));
        textField.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(200, 200, 200)),
            BorderFactory.createEmptyBorder(5, 5, 5, 5)
        ));
        return textField;
    }
    
    private JButton createButton(String text, Color bgColor) {
        JButton button = new JButton(text);
        button.setBackground(bgColor);
        button.setForeground(Color.WHITE);
        button.setFont(new Font("Arial", Font.BOLD, 11));
        button.setFocusPainted(false);
        button.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(bgColor.darker()),
            BorderFactory.createEmptyBorder(8, 15, 8, 15)
        ));
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setAlignmentX(Component.CENTER_ALIGNMENT);
        button.setMaximumSize(new Dimension(200, 40));
        return button;
    }
    
    private void setupEventListeners() {
        btnAjouter.addActionListener(e -> activerAjout());
        btnModifier.addActionListener(e -> activerModification());
        btnEnregistrer.addActionListener(e -> enregistrerExploitation());
        btnSupprimer.addActionListener(e -> supprimerExploitation());
        btnRechercher.addActionListener(e -> chercherExploitation());
        btnActualiser.addActionListener(e -> actualiserTableau());
        btnStats.addActionListener(e -> afficherStatistiques());
        
        table.getSelectionModel().addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting()) {
                remplirChampsDepuisTable();
            }
        });
    }
    
    // M√âTHODES DE CACHE - REMPLACENT findById()
    private void chargerCache() {
        try {
            // Charger toutes les villes dans le cache
            List<Ville> villes = villeDAO.findAll();
            cacheVilles.clear();
            for (Ville ville : villes) {
                cacheVilles.put(ville.getIdVille(), ville.getNomVille() + " (" + ville.getCodePostal() + ")");
            }
            
            // Charger toutes les agences dans le cache
            List<Agence> agences = agenceDAO.findAll();
            cacheAgences.clear();
            for (Agence agence : agences) {
                cacheAgences.put(agence.getIdAgence(), agence.getNomAgence());
            }
            
            System.out.println("‚úÖ Cache charg√©: " + cacheVilles.size() + " villes, " + cacheAgences.size() + " agences");
        } catch (Exception e) {
            System.err.println("‚ùå Erreur chargement cache: " + e.getMessage());
        }
    }
    
    private String getNomVilleFromCache(Long idVille) {
        if (idVille == null) return "N/A";
        String nom = cacheVilles.get(idVille);
        return nom != null ? nom : "ID: " + idVille;
    }
    
    private String getNomAgenceFromCache(Long idAgence) {
        if (idAgence == null) return "N/A";
        String nom = cacheAgences.get(idAgence);
        return nom != null ? nom : "ID: " + idAgence;
    }
    
    private void chargerComboBox() {
        comboVille.removeAllItems();
        comboVille.addItem("-- S√©lectionner une ville --");
        
        comboAgence.removeAllItems();
        comboAgence.addItem("-- S√©lectionner une agence --");
        
        try {
            // Remplir avec les donn√©es du cache
            for (Map.Entry<Long, String> entry : cacheVilles.entrySet()) {
                comboVille.addItem(entry.getKey() + " - " + entry.getValue());
            }
            
            for (Map.Entry<Long, String> entry : cacheAgences.entrySet()) {
                comboAgence.addItem(entry.getKey() + " - " + entry.getValue());
            }
        } catch (Exception e) {
            System.err.println("‚ùå Erreur chargement combobox: " + e.getMessage());
        }
    }
    
    private void updateStats() {
        try {
            Component statsPanel = getComponent(0);
            if (statsPanel instanceof JPanel) {
                for (Component comp : ((JPanel) statsPanel).getComponents()) {
                    if (comp instanceof JLabel) {
                        JLabel label = (JLabel) comp;
                        if (label.getText().startsWith("Total:")) {
                            long total = exploitationDAO.count();
                            label.setText("Total: " + total + " exploitation(s)");
                        } else if (label.getText().startsWith("Superficie totale:")) {
                            double superficie = exploitationDAO.getTotalSuperficie();
                            label.setText("Superficie totale: " + String.format("%.2f", superficie) + " ha");
                        }
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("‚ùå Erreur mise √† jour statistiques: " + e.getMessage());
        }
    }
    
    // M√âTHODES FONCTIONNELLES PRINCIPALES
    private void activerAjout() {
        isEditMode = false;
        currentEditId = null;
        viderChamps();
        chargerComboBox();
        txtNom.requestFocus();
        mettreAJourBoutons();
        JOptionPane.showMessageDialog(this,
            "Mode AJOUT activ√©.\nRemplissez les champs et cliquez sur ENREGISTRER.",
            "Information",
            JOptionPane.INFORMATION_MESSAGE);
    }
    
    private void activerModification() {
        int row = table.getSelectedRow();
        if (row >= 0) {
            isEditMode = true;
            Object idObj = model.getValueAt(row, 0);
            if (idObj instanceof Long) {
                currentEditId = (Long) idObj;
            } else {
                try {
                    currentEditId = Long.parseLong(idObj.toString());
                } catch (NumberFormatException e) {
                    currentEditId = null;
                }
            }
            remplirChampsDepuisTable();
            mettreAJourBoutons();
        } else {
            JOptionPane.showMessageDialog(this,
                "Veuillez s√©lectionner une exploitation √† modifier.",
                "Aucune s√©lection",
                JOptionPane.WARNING_MESSAGE);
        }
    }
    
    private void enregistrerExploitation() {
        try {
            // Validation des champs
            String nom = txtNom.getText().trim();
            String type = txtType.getText().trim();
            String superficieStr = txtSuperficie.getText().trim();
            String adresse = txtAdresse.getText().trim();
            String villeSelection = (String) comboVille.getSelectedItem();
            String agenceSelection = (String) comboAgence.getSelectedItem();
            
            if (nom.isEmpty() || 
                villeSelection == null || villeSelection.equals("-- S√©lectionner une ville --") ||
                agenceSelection == null || agenceSelection.equals("-- S√©lectionner une agence --")) {
                JOptionPane.showMessageDialog(this,
                    "Les champs marqu√©s d'un * sont obligatoires !",
                    "Champs manquants",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }
            
            // Validation superficie
            Double superficie = null;
            if (!superficieStr.isEmpty()) {
                try {
                    superficie = Double.parseDouble(superficieStr);
                    if (superficie < 0) {
                        JOptionPane.showMessageDialog(this,
                            "La superficie doit √™tre positive !",
                            "Superficie invalide",
                            JOptionPane.ERROR_MESSAGE);
                        return;
                    }
                } catch (NumberFormatException e) {
                    JOptionPane.showMessageDialog(this,
                        "Superficie invalide ! Doit √™tre un nombre.",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                    return;
                }
            }
            
            // R√©cup√©rer IDs des combobox
            Long idVille;
            Long idAgence;
            
            try {
                String[] villeParts = villeSelection.split(" - ");
                idVille = Long.parseLong(villeParts[0]);
                
                String[] agenceParts = agenceSelection.split(" - ");
                idAgence = Long.parseLong(agenceParts[0]);
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this,
                    "S√©lection invalide",
                    "Erreur",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }
            
            if (!isEditMode) {
                // AJOUT
                Exploitation nouvelle = new Exploitation();
                nouvelle.setNomExploitation(nom);
                nouvelle.setTypeExploitation(type);
                nouvelle.setSuperficie(superficie);
                nouvelle.setAdresse(adresse);
                nouvelle.setIdVille(idVille);
                nouvelle.setIdAgence(idAgence);
                
                if (exploitationDAO.save(nouvelle)) {
                    JOptionPane.showMessageDialog(this,
                        "Exploitation ajout√©e avec succ√®s !\nID : " + nouvelle.getIdExploitation(),
                        "Succ√®s",
                        JOptionPane.INFORMATION_MESSAGE);
                    chargerDonnees();
                    viderChamps();
                    updateStats();
                }
            } else {
                // MODIFICATION
                if (currentEditId == null) {
                    JOptionPane.showMessageDialog(this,
                        "ID invalide pour la modification",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                    return;
                }
                
                Exploitation exploitation = exploitationDAO.findById(currentEditId);
                if (exploitation == null) {
                    JOptionPane.showMessageDialog(this,
                        "Exploitation introuvable dans la base de donn√©es",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                    return;
                }
                
                exploitation.setNomExploitation(nom);
                exploitation.setTypeExploitation(type);
                exploitation.setSuperficie(superficie);
                exploitation.setAdresse(adresse);
                exploitation.setIdVille(idVille);
                exploitation.setIdAgence(idAgence);
                
                if (exploitationDAO.update(exploitation)) {
                    JOptionPane.showMessageDialog(this,
                        "Exploitation modifi√©e avec succ√®s !",
                        "Succ√®s",
                        JOptionPane.INFORMATION_MESSAGE);
                    chargerDonnees();
                    viderChamps();
                    isEditMode = false;
                    currentEditId = null;
                    mettreAJourBoutons();
                    updateStats();
                }
            }
            
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this,
                "Erreur : " + ex.getMessage(),
                "Erreur",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void supprimerExploitation() {
        int row = table.getSelectedRow();
        if (row >= 0) {
            Object idObj = model.getValueAt(row, 0);
            Long id = null;
            
            if (idObj instanceof Long) {
                id = (Long) idObj;
            } else {
                try {
                    id = Long.parseLong(idObj.toString());
                } catch (NumberFormatException e) {
                    JOptionPane.showMessageDialog(this,
                        "ID invalide",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                    return;
                }
            }
            
            String nom = model.getValueAt(row, 1).toString();
            String superficie = model.getValueAt(row, 3).toString();
            
            int confirm = JOptionPane.showConfirmDialog(this,
                "√ätes-vous s√ªr de vouloir supprimer cette exploitation ?\n\n" +
                "ID : " + id + "\n" +
                "Nom : " + nom + "\n" +
                "Superficie : " + superficie + " ha",
                "Confirmation de suppression",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.WARNING_MESSAGE);
            
            if (confirm == JOptionPane.YES_OPTION) {
                if (exploitationDAO.deleteById(id)) {
                    JOptionPane.showMessageDialog(this,
                        "Exploitation supprim√©e avec succ√®s !",
                        "Succ√®s",
                        JOptionPane.INFORMATION_MESSAGE);
                    chargerDonnees();
                    viderChamps();
                    updateStats();
                } else {
                    JOptionPane.showMessageDialog(this,
                        "√âchec de la suppression",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                }
            }
        } else {
            JOptionPane.showMessageDialog(this,
                "Veuillez s√©lectionner une exploitation √† supprimer.",
                "Aucune s√©lection",
                JOptionPane.WARNING_MESSAGE);
        }
    }
    
    private void chercherExploitation() {
        String searchText = txtSearch.getText().trim();
        if (searchText.isEmpty()) {
            chargerDonnees();
            return;
        }
        
        List<Exploitation> resultats = exploitationDAO.search(searchText);
        model.setRowCount(0);
        
        if (resultats.isEmpty()) {
            JOptionPane.showMessageDialog(this,
                "Aucun r√©sultat trouv√© pour : \"" + searchText + "\"",
                "Recherche",
                JOptionPane.INFORMATION_MESSAGE);
        } else {
            for (Exploitation e : resultats) {
                model.addRow(new Object[]{
                    e.getIdExploitation(),
                    e.getNomExploitation(),
                    e.getTypeExploitation(),
                    e.getSuperficie(),
                    e.getAdresse(),
                    getNomVilleFromCache(e.getIdVille()),
                    getNomAgenceFromCache(e.getIdAgence())
                });
            }
            
            JOptionPane.showMessageDialog(this,
                resultats.size() + " r√©sultat(s) trouv√©(s)",
                "Recherche",
                JOptionPane.INFORMATION_MESSAGE);
        }
    }
    
    private void afficherStatistiques() {
        try {
            long total = exploitationDAO.count();
            double superficieTotale = exploitationDAO.getTotalSuperficie();
            List<Exploitation> exploitations = exploitationDAO.findAll();
            
            if (exploitations.isEmpty()) {
                JOptionPane.showMessageDialog(this,
                    "Aucune exploitation dans la base de donn√©es.",
                    "Statistiques",
                    JOptionPane.INFORMATION_MESSAGE);
                return;
            }
            
            // Calculer la superficie moyenne
            double superficieMoyenne = superficieTotale / total;
            
            // Trouver la plus grande et la plus petite exploitation
            Exploitation plusGrande = exploitations.get(0);
            Exploitation plusPetite = exploitations.get(0);
            
            for (Exploitation e : exploitations) {
                if (e.getSuperficie() != null) {
                    if (plusGrande.getSuperficie() == null || 
                        e.getSuperficie() > plusGrande.getSuperficie()) {
                        plusGrande = e;
                    }
                    if (plusPetite.getSuperficie() == null || 
                        e.getSuperficie() < plusPetite.getSuperficie()) {
                        plusPetite = e;
                    }
                }
            }
            
            StringBuilder stats = new StringBuilder();
            stats.append("üìä STATISTIQUES DES EXPLOITATIONS\n");
            stats.append("================================\n");
            stats.append("‚Ä¢ Nombre total : ").append(total).append(" exploitation(s)\n");
            stats.append("‚Ä¢ Superficie totale : ").append(String.format("%.2f", superficieTotale)).append(" ha\n");
            stats.append("‚Ä¢ Superficie moyenne : ").append(String.format("%.2f", superficieMoyenne)).append(" ha\n\n");
            
            if (plusGrande.getSuperficie() != null) {
                stats.append("üèÜ PLUS GRANDE EXPLOITATION :\n");
                stats.append("   Nom : ").append(plusGrande.getNomExploitation()).append("\n");
                stats.append("   Superficie : ").append(plusGrande.getSuperficie()).append(" ha\n");
                stats.append("   Type : ").append(plusGrande.getTypeExploitation()).append("\n\n");
            }
            
            if (plusPetite.getSuperficie() != null) {
                stats.append("üìè PLUS PETITE EXPLOITATION :\n");
                stats.append("   Nom : ").append(plusPetite.getNomExploitation()).append("\n");
                stats.append("   Superficie : ").append(plusPetite.getSuperficie()).append(" ha\n");
                stats.append("   Type : ").append(plusPetite.getTypeExploitation());
            }
            
            JOptionPane.showMessageDialog(this,
                stats.toString(),
                "Statistiques D√©taill√©es",
                JOptionPane.INFORMATION_MESSAGE);
            
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                "Erreur lors du calcul des statistiques: " + e.getMessage(),
                "Erreur",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void actualiserTableau() {
        chargerCache(); // Recharger le cache
        chargerDonnees();
        viderChamps();
        chargerComboBox();
        txtSearch.setText("");
        isEditMode = false;
        currentEditId = null;
        mettreAJourBoutons();
        updateStats();
        JOptionPane.showMessageDialog(this,
            "Tableau actualis√© !",
            "Actualisation",
            JOptionPane.INFORMATION_MESSAGE);
    }
    
    private void chargerDonnees() {
        SwingWorker<Void, Void> worker = new SwingWorker<Void, Void>() {
            @Override
            protected Void doInBackground() throws Exception {
                try {
                    List<Exploitation> exploitations = exploitationDAO.findAll();
                    SwingUtilities.invokeLater(() -> {
                        model.setRowCount(0);
                        for (Exploitation e : exploitations) {
                            model.addRow(new Object[]{
                                e.getIdExploitation(),
                                e.getNomExploitation(),
                                e.getTypeExploitation(),
                                e.getSuperficie(),
                                e.getAdresse(),
                                getNomVilleFromCache(e.getIdVille()),
                                getNomAgenceFromCache(e.getIdAgence())
                            });
                        }
                    });
                } catch (Exception e) {
                    e.printStackTrace();
                }
                return null;
            }
            
            @Override
            protected void done() {
                try {
                    get();
                } catch (Exception e) {
                    JOptionPane.showMessageDialog(ExploitationPanel.this,
                        "Erreur lors du chargement : " + e.getMessage(),
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                }
            }
        };
        
        worker.execute();
    }
    
    private void viderChamps() {
        txtNom.setText("");
        txtType.setText("");
        txtSuperficie.setText("");
        txtAdresse.setText("");
        if (comboVille.getItemCount() > 0) comboVille.setSelectedIndex(0);
        if (comboAgence.getItemCount() > 0) comboAgence.setSelectedIndex(0);
    }
    
    private void mettreAJourBoutons() {
        btnEnregistrer.setEnabled(true);
        btnAjouter.setEnabled(!isEditMode);
        btnModifier.setEnabled(!isEditMode);
        btnSupprimer.setEnabled(!isEditMode);
        
        if (isEditMode) {
            btnEnregistrer.setText("üíæ METTRE √Ä JOUR");
            btnEnregistrer.setBackground(new Color(255, 140, 0));
        } else {
            btnEnregistrer.setText("üíæ ENREGISTRER");
            btnEnregistrer.setBackground(new Color(60, 179, 113));
        }
    }
    
    private void remplirChampsDepuisTable() {
        int row = table.getSelectedRow();
        if (row >= 0) {
            txtNom.setText(model.getValueAt(row, 1).toString());
            txtType.setText(model.getValueAt(row, 2).toString());
            txtSuperficie.setText(model.getValueAt(row, 3).toString());
            txtAdresse.setText(model.getValueAt(row, 4).toString());
            
            // Pour les combobox, on doit trouver l'index correspondant
            String villeInfo = model.getValueAt(row, 5).toString();
            String agenceInfo = model.getValueAt(row, 6).toString();
            
            // Rechercher dans les combobox
            for (int i = 0; i < comboVille.getItemCount(); i++) {
                String item = comboVille.getItemAt(i);
                if (item.contains(villeInfo)) {
                    comboVille.setSelectedIndex(i);
                    break;
                }
            }
            
            for (int i = 0; i < comboAgence.getItemCount(); i++) {
                String item = comboAgence.getItemAt(i);
                if (item.contains(agenceInfo)) {
                    comboAgence.setSelectedIndex(i);
                    break;
                }
            }
        }
    }
    
    // GETTER
    public List<Exploitation> getExploitations() {
        return exploitationDAO.findAll();
    }
}