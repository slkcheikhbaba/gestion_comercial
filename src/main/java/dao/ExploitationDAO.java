package dao;

import model.Exploitation;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;
import util.HibernateUtil;
import java.util.ArrayList;
import java.util.List;

public class ExploitationDAO {

    // CREATE - Ajouter une exploitation
    public boolean save(Exploitation exploitation) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction transaction = null;
        boolean success = false;
        
        try {
            transaction = session.beginTransaction();
            session.save(exploitation);
            transaction.commit();
            success = true;
            System.out.println("‚úÖ Exploitation ajout√©e: " + exploitation.getNomExploitation());
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            System.err.println("‚ùå Erreur save(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return success;
    }

    // READ ALL - R√©cup√©rer toutes les exploitations
    public List<Exploitation> findAll() {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<Exploitation> exploitations = new ArrayList<>();
        
        try {
            Query<Exploitation> query = session.createQuery(
                "FROM Exploitation ORDER BY nomExploitation",
                Exploitation.class
            );
            exploitations = query.list();
            System.out.println("üìä " + exploitations.size() + " exploitation(s) trouv√©e(s)");
        } catch (Exception e) {
            System.err.println("‚ùå Erreur findAll(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitations;
    }

    // READ BY ID - R√©cup√©rer une exploitation par ID
    public Exploitation findById(Long id) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Exploitation exploitation = null;
        try {
            exploitation = session.get(Exploitation.class, id);
            if (exploitation != null) {
                System.out.println("üîç Exploitation trouv√©e ID " + id + ": " + exploitation.getNomExploitation());
            }
        } catch (Exception e) {
            System.err.println("‚ùå Erreur findById(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitation;
    }

    // UPDATE - Mettre √† jour une exploitation
    public boolean update(Exploitation exploitation) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction transaction = null;
        boolean success = false;
        
        try {
            transaction = session.beginTransaction();
            session.update(exploitation);
            transaction.commit();
            success = true;
            System.out.println("‚úÖ Exploitation mise √† jour ID " + exploitation.getIdExploitation());
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            System.err.println("‚ùå Erreur update(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return success;
    }

    // DELETE - Supprimer une exploitation
    public boolean delete(Exploitation exploitation) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction transaction = null;
        boolean success = false;
        
        try {
            transaction = session.beginTransaction();
            session.delete(exploitation);
            transaction.commit();
            success = true;
            System.out.println("‚úÖ Exploitation supprim√©e ID " + exploitation.getIdExploitation());
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            System.err.println("‚ùå Erreur delete(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return success;
    }

    // DELETE BY ID - Supprimer une exploitation par ID
    public boolean deleteById(Long id) {
        Exploitation exploitation = findById(id);
        if (exploitation != null) {
            return delete(exploitation);
        }
        System.err.println("‚ö†Ô∏è Exploitation ID " + id + " non trouv√©e pour suppression");
        return false;
    }

    // SEARCH - Rechercher des exploitations
    public List<Exploitation> search(String searchText) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<Exploitation> exploitations = new ArrayList<>();
        
        try {
            Query<Exploitation> query = session.createQuery(
                "FROM Exploitation e WHERE LOWER(e.nomExploitation) LIKE LOWER(:search) " +
                "OR LOWER(e.typeExploitation) LIKE LOWER(:search) " +
                "OR LOWER(e.adresse) LIKE LOWER(:search) " +
                "ORDER BY e.nomExploitation",
                Exploitation.class
            );
            query.setParameter("search", "%" + searchText + "%");
            exploitations = query.list();
            System.out.println("üîé " + exploitations.size() + " r√©sultat(s) pour '" + searchText + "'");
        } catch (Exception e) {
            System.err.println("‚ùå Erreur search(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitations;
    }

    // FIND BY VILLE - Rechercher les exploitations d'une ville
    public List<Exploitation> findByVilleId(Long idVille) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<Exploitation> exploitations = new ArrayList<>();
        
        try {
            Query<Exploitation> query = session.createQuery(
                "FROM Exploitation e WHERE e.idVille = :idVille ORDER BY e.nomExploitation",
                Exploitation.class
            );
            query.setParameter("idVille", idVille);
            exploitations = query.list();
        } catch (Exception e) {
            System.err.println("‚ùå Erreur findByVilleId(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitations;
    }

    // FIND BY AGENCE - Rechercher les exploitations d'une agence
    public List<Exploitation> findByAgenceId(Long idAgence) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<Exploitation> exploitations = new ArrayList<>();
        
        try {
            Query<Exploitation> query = session.createQuery(
                "FROM Exploitation e WHERE e.idAgence = :idAgence ORDER BY e.nomExploitation",
                Exploitation.class
            );
            query.setParameter("idAgence", idAgence);
            exploitations = query.list();
        } catch (Exception e) {
            System.err.println("‚ùå Erreur findByAgenceId(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitations;
    }

    // FIND BY SUPERFICIE - Rechercher par superficie minimale
    public List<Exploitation> findBySuperficieMin(Double superficieMin) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<Exploitation> exploitations = new ArrayList<>();
        
        try {
            Query<Exploitation> query = session.createQuery(
                "FROM Exploitation e WHERE e.superficie >= :superficie ORDER BY e.superficie DESC",
                Exploitation.class
            );
            query.setParameter("superficie", superficieMin);
            exploitations = query.list();
        } catch (Exception e) {
            System.err.println("‚ùå Erreur findBySuperficieMin(): " + e.getMessage());
            e.printStackTrace();
        } finally {
            session.close();
        }
        return exploitations;
    }

    // COUNT - Compter le nombre d'exploitations
    public long count() {
        Session session = HibernateUtil.getSessionFactory().openSession();
        try {
            Query<Long> query = session.createQuery("SELECT COUNT(e) FROM Exploitation e", Long.class);
            Long result = query.uniqueResult();
            return result != null ? result : 0;
        } catch (Exception e) {
            System.err.println("‚ùå Erreur count(): " + e.getMessage());
            return 0;
        } finally {
            session.close();
        }
    }

    // TOTAL SUPERFICIE - Calculer la superficie totale
    public double getTotalSuperficie() {
        Session session = HibernateUtil.getSessionFactory().openSession();
        try {
            Query<Double> query = session.createQuery("SELECT SUM(e.superficie) FROM Exploitation e", Double.class);
            Double result = query.uniqueResult();
            return result != null ? result : 0.0;
        } catch (Exception e) {
            System.err.println("‚ùå Erreur getTotalSuperficie(): " + e.getMessage());
            return 0.0;
        } finally {
            session.close();
        }
    }

    // AFFICHER TOUTES LES EXPLOITATIONS (pour tests)
    public void afficherToutesExploitations() {
        try {
            List<Exploitation> exploitations = findAll();
            System.out.println("=== LISTE DES EXPLOITATIONS ===");
            for (Exploitation exploitation : exploitations) {
                System.out.println(
                    "ID: " + exploitation.getIdExploitation() +
                    " | Nom: " + exploitation.getNomExploitation() +
                    " | Type: " + exploitation.getTypeExploitation() +
                    " | Superficie: " + exploitation.getSuperficie() +
                    " ha | Ville ID: " + exploitation.getIdVille() +
                    " | Agence ID: " + exploitation.getIdAgence()
                );
            }
            System.out.println("Total: " + exploitations.size() + " exploitation(s)");
            System.out.println("Superficie totale: " + getTotalSuperficie() + " ha");
        } catch (Exception e) {
            System.err.println("Erreur: " + e.getMessage());
        }
    }
    
    // M√âTHODE MAIN DE TEST
    public static void main(String[] args) {
        System.out.println("üß™ TEST EXPLOITATIONDAO");
        System.out.println("========================");
        
        ExploitationDAO dao = new ExploitationDAO();
        
        // Test connexion et comptage
        System.out.println("\n1. üîó TEST CONNEXION ET COMPTAGE:");
        long total = dao.count();
        System.out.println("Nombre total d'exploitations: " + total);
        
        // Afficher toutes les exploitations
        System.out.println("\n2. üìã TEST FIND ALL:");
        dao.afficherToutesExploitations();
        
        // Test recherche
        System.out.println("\n3. üîç TEST RECHERCHE:");
        List<Exploitation> resultats = dao.search("ferme");
        System.out.println("R√©sultats recherche 'ferme': " + resultats.size());
        
        // Test superficie
        System.out.println("\n4. üìè TEST SUPERFICIE:");
        double superficieTotale = dao.getTotalSuperficie();
        System.out.println("Superficie totale: " + superficieTotale + " ha");
        
        System.out.println("\n‚úÖ TESTS TERMIN√âS");
    }
}